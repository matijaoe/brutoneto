import { load } from 'cheerio'
import prettier from 'prettier'
import {
  basicKebabCase,
  convertFromPercentage,
  localizedTitleCase,
  replaceDiacritics,
  writeFile,
} from './utils'

type PlaceTaxesRecord = {
  jedinica: string
  nizaStopa: number
  visaStopa: number
}

const SOURCE_URL
  = 'https://isplate.info/porez-na-dohodak-porezne-stope.aspx'

async function generateTaxRecords(): Promise<PlaceTaxesRecord[]> {
  const res = await fetch(SOURCE_URL)
  if (!res.ok) {
    throw new Error(
      `Failed to fetch "${SOURCE_URL}": ${res.status} ${res.statusText}`,
    )
  }

  const html = await res.text()
  const $ = load(html)
  const taxRateRecords: PlaceTaxesRecord[] = []

  $('div.post-content article').each((_idx, article) => {
    const jedinica = $(article).find('h3 strong').first().text().trim()
    const spans = $(article)
      .find('tr.m-3 span.display-2')
      .slice(0, 2)

    const [low, high] = [$(spans[0]).text(), $(spans[1]).text()]

    if (jedinica && low && high) {
      taxRateRecords.push({
        jedinica: localizedTitleCase(jedinica),
        nizaStopa: convertFromPercentage(low),
        visaStopa: convertFromPercentage(high),
      })
    }
  })

  return taxRateRecords
}

async function writeTaxRecords(taxRecords: PlaceTaxesRecord[]) {
  const written = await writeFile(
    'src/data/places.json',
    JSON.stringify(taxRecords, null, 2),
  )

  if (written) {
    console.log('✅ Tax rates written to "/src/data/places.json"')
  } else {
    console.error('❌ Error writing tax rates file')
  }
}
async function writeGeneratedCode(content: string) {
  const written = await writeFile('src/data/places.ts', content)
  if (written) {
    console.log(
      '✅ Places code generated and written to "/src/data/places.ts"',
    )
  } else {
    console.error('❌ Error writing places type file')
  }
}

const taxRecords = await generateTaxRecords()
const placeNames = taxRecords.map((record) => record.jedinica)

const PlaceMap = taxRecords.reduce(
  (acc, record) => {
    const { jedinica, visaStopa, nizaStopa } = record
    const key = basicKebabCase(replaceDiacritics(jedinica))
    acc[key] = {
      name: jedinica,
      taxRateLow: nizaStopa,
      taxRateHigh: visaStopa,
    }
    return acc
  },
  {} as Record<string, { name: string, taxRateLow: number, taxRateHigh: number }>,
)

const places = Object.keys(PlaceMap)

async function generateCode() {
  // ---------------------------------------------------------------------
  // ⚠️  AUTO-GENERATED FILE – DO NOT EDIT MANUALLY.
  // ---------------------------------------------------------------------
  const headerComment = `// This file was generated by "gen-tax-rates.ts".`

  const mapJSDoc = `
/**
 * Tax rates for different places in Croatia.
 * Data source: "${SOURCE_URL}" → serialized to "places.json".
 */`.trim()

  const placeMapCode = `export const PlaceMap = ${JSON.stringify(
    PlaceMap,
    null,
    2,
  )} as const`

  const placeAliasCode = `export type Place = keyof typeof PlaceMap`

  const placesArrayCode = `export const places: Place[] = ${JSON.stringify(
    places,
    null,
    2,
  )} as const`

  // Proper string-literal union: one pipe per line for readability
  const placeNameUnion = placeNames.map((p) => `'${p}'`).join('\n  | ')
  const placeNameCode = `export type PlaceName =\n  | ${placeNameUnion}`

  // Assemble the file in a predictable order
  const rawContent = [
    headerComment,
    '',
    mapJSDoc,
    placeMapCode,
    '',
    placeAliasCode,
    '',
    placesArrayCode,
    '',
    placeNameCode,
  ].join('\n\n')

  return prettier.format(rawContent, { parser: 'typescript' })
}

await writeTaxRecords(taxRecords)

await writeGeneratedCode(await generateCode())
